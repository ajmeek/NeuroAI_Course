
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Tutorial 3: Generalization in Cognitive Science — Neuromatch Academy: NeuroAI</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link href="../../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../../_static/styles/sphinx-book-theme.css?digest=4ec06e9971c5264fbd345897d5258098f11cc577" rel="stylesheet" type="text/css">
<link href="../../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css">
<link href="../../../_static/custom.css" rel="stylesheet" type="text/css">
<link href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94" rel="preload"/>
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94" rel="preload"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script src="../../../_static/doctools.js"></script>
<script src="../../../_static/clipboard.min.js"></script>
<script src="../../../_static/copybutton.js"></script>
<script src="../../../_static/scripts/sphinx-book-theme.js?digest=8bf782fb4ee92b3d3646425e50f299c4e1fd152d"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../../../_static/togglebutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script src="../../../_static/design-tabs.js"></script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
<script async="async" src="../../../_static/sphinx-thebe.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/W1D1_Generalization/student/W1D1_Tutorial3';</script>
<link href="../../../_static/ai-logo.png" rel="shortcut icon">
<link href="../../../genindex.html" rel="index" title="Index">
<link href="../../../search.html" rel="search" title="Search"/>
<link href="W1D1_Outro.html" rel="next" title="Outro"/>
<link href="W1D1_Tutorial2.html" rel="prev" title="Tutorial 2: Generalization in Neuroscience"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</link></link></link></link></link></link></link></link></link></head>
<body data-default-mode="" data-offset="180" data-spy="scroll" data-target="#bd-toc-nav">
<a class="skip-link" href="#main-content">Skip to main content</a>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
<nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
<label class="sidebar-toggle primary-toggle" for="__primary">
<span class="fa-solid fa-bars"></span>
</label>
<div id="navbar-start">
<a class="navbar-brand logo" href="../../intro.html">
<img alt="Logo image" class="logo__image only-light" src="../../../_static/ai-logo.png"/>
<img alt="Logo image" class="logo__image only-dark" src="../../../_static/ai-logo.png"/>
</a>
</div>
<div class="col-lg-9 navbar-header-items">
<div class="mr-auto" id="navbar-center">
<div class="navbar-center-item">
<nav class="navbar-nav">
<p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
<ul class="navbar-nav" id="navbar-main-elements">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../Schedule/schedule_intro.html">
                        Schedule
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/tech_intro.html">
                        Technical Help
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/Links_Policy.html">
                        Quick links and policies
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../prereqs/NeuroAI.html">
                        Prerequisites and preparatory materials for NeuroAI course
                      </a>
</li>
<li class="nav-item current active">
<a class="nav-link nav-internal" href="../chapter_title.html">
                        Generalization (W1D1)
                      </a>
</li>
<div class="nav-item dropdown">
<button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-toggle="dropdown" type="button">
                    More
                </button>
<div class="dropdown-menu">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D2_ComparingTasks/chapter_title.html">
                        Comparing Tasks (W1D2)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/chapter_title.html">
                        Comparing Artificial And Biological Networks (W1D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D5_Microcircuits/chapter_title.html">
                        Microcircuits (W1D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D1_Macrocircuits/chapter_title.html">
                        Macrocircuits (W2D1)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D2_NeuroSymbolicStructures/chapter_title.html">
                        Neuro Symbolic Structures (W2D2)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D3_Microlearning/chapter_title.html">
                        Microlearning (W2D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D4_Macrolearning/chapter_title.html">
                        Macrolearning (W2D4)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D5_Mysteries/chapter_title.html">
                        Mysteries (W2D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/project_guidance.html">
                        Daily guide for projects
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/datasets_overview.html">
                        Project materials
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/impact_talks.html">
                        Impact Talks
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/mentorship_program.html">
                        Mentorship Program
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/career_features.html">
                        Career Features
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/career_panels.html">
                        Career Panels
                      </a>
</li>
</div>
</div>
</ul>
</nav>
</div>
</div>
<div id="navbar-end">
<div class="navbar-end-item navbar-persistent--container">
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
<i class="fa-solid fa-magnifying-glass"></i>
</button>
</div>
<div class="navbar-end-item">
<button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
<span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
<span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
<span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
</div>
<div class="navbar-end-item">
<ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
</ul>
</div>
</div>
</div>
<div class="navbar-persistent--mobile">
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
<i class="fa-solid fa-magnifying-glass"></i>
</button>
</div>
<label class="sidebar-toggle secondary-toggle" for="__secondary">
<span class="fa-solid fa-outdent"></span>
</label>
</div>
</nav>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-center-item">
<nav class="navbar-nav">
<p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
<ul class="navbar-nav" id="navbar-main-elements">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../Schedule/schedule_intro.html">
                        Schedule
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/tech_intro.html">
                        Technical Help
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/Links_Policy.html">
                        Quick links and policies
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../prereqs/NeuroAI.html">
                        Prerequisites and preparatory materials for NeuroAI course
                      </a>
</li>
<li class="nav-item current active">
<a class="nav-link nav-internal" href="../chapter_title.html">
                        Generalization (W1D1)
                      </a>
</li>
<div class="nav-item dropdown">
<button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-toggle="dropdown" type="button">
                    More
                </button>
<div class="dropdown-menu">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D2_ComparingTasks/chapter_title.html">
                        Comparing Tasks (W1D2)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/chapter_title.html">
                        Comparing Artificial And Biological Networks (W1D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D5_Microcircuits/chapter_title.html">
                        Microcircuits (W1D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D1_Macrocircuits/chapter_title.html">
                        Macrocircuits (W2D1)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D2_NeuroSymbolicStructures/chapter_title.html">
                        Neuro Symbolic Structures (W2D2)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D3_Microlearning/chapter_title.html">
                        Microlearning (W2D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D4_Macrolearning/chapter_title.html">
                        Macrolearning (W2D4)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D5_Mysteries/chapter_title.html">
                        Mysteries (W2D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/project_guidance.html">
                        Daily guide for projects
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/datasets_overview.html">
                        Project materials
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/impact_talks.html">
                        Impact Talks
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/mentorship_program.html">
                        Mentorship Program
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/career_features.html">
                        Career Features
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/career_panels.html">
                        Career Panels
                      </a>
</li>
</div>
</div>
</ul>
</nav>
</div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-end-item">
<button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
<span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
<span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
<span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
</div>
<div class="navbar-end-item">
<ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
</ul>
</div>
</div>
</div>
<div class="sidebar-start-items sidebar-primary__section">
<div class="sidebar-start-items__item">
<a class="navbar-brand logo" href="../../intro.html">
<img alt="Logo image" class="logo__image only-light" src="../../../_static/ai-logo.png"/>
<img alt="Logo image" class="logo__image only-dark" src="../../../_static/ai-logo.png"/>
</a>
</div>
<div class="sidebar-start-items__item">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="sidebar-start-items__item"><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<ul class="nav bd-sidenav bd-sidenav__home-link">
<li class="toctree-l1">
<a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Schedule/schedule_intro.html">Schedule</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Schedule/daily_schedules.html">General schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Schedule/shared_calendars.html">Shared calendars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Schedule/timezone_widget.html">Timezone widget</a></li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../TechnicalHelp/tech_intro.html">Technical Help</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../TechnicalHelp/Jupyterbook.html">Using jupyterbook</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TechnicalHelp/Tutorial_colab.html">Using Google Colab</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TechnicalHelp/Tutorial_kaggle.html">Using Kaggle</a></li>
</ul>
</input></li>
<li class="toctree-l2"><a class="reference internal" href="../../TechnicalHelp/Discord.html">Using discord</a></li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../TechnicalHelp/Links_Policy.html">Quick links and policies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../prereqs/NeuroAI.html">Prerequisites and preparatory materials for NeuroAI course</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Foundations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../chapter_title.html">Generalization (W1D1)</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="W1D1_Intro.html">W1D1 Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D1_Tutorial1.html">Tutorial 1: Generalization in AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D1_Tutorial2.html">Tutorial 2: Generalization in Neuroscience</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Tutorial 3: Generalization in Cognitive Science</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D1_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D1_DaySummary.html">Day Summary</a></li>
</ul>
</input></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W1D2_ComparingTasks/chapter_title.html">Comparing Tasks (W1D2)</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Intro.html">W1D2 Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Tutorial1.html"><strong>Tutorial 1:Task definition, application, relations and impacts on generalization</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Tutorial2.html">Tutorial 2: Contrastive learning for object recognition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Tutorial3.html">Tutorial 3: Reinforcement learning across temporal scales</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Outro.html">W1D2 Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_DaySummary.html">W1D1 Day Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/chapter_title.html">Comparing Artificial And Biological Networks (W1D3)</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial1.html">Tutorial 1: Generalization and representational geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial2.html">Tutorial 2: Computation as transformation of representational geometries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial3.html">Tutorial 3: Representational geometry &amp; noise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial4.html">Tutorial 4: Statistical inference on representational geometries</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Architectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W1D5_Microcircuits/chapter_title.html">Microcircuits (W1D5)</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Tutorial1.html">Tutorial 1: Sparsity and Sparse Coding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Tutorial2.html">Tutorial 2: Normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Tutorial3.html">Tutorial 3: Attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_DaySummary.html">Day Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D1_Macrocircuits/chapter_title.html">Macrocircuits (W2D1)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Tutorial1.html">Tutorial 1: Depth vs Width</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/further_reading.html">Suggested further readings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_DaySummary.html">Day Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/chapter_title.html">Neuro Symbolic Structures (W2D2)</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/student/W2D2_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/student/W2D2_Tutorial1.html">Tutorial 1: Basic operations of vector symbolic algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/student/W2D2_Tutorial2.html">Tutorial 2: Learning from structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/student/W2D2_Tutorial3.html">Tutorial 3: Generalizing representations in continuous space</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/student/W2D2_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/further_reading.html">Suggested further readings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicStructures/student/W2D2_DaySummary.html">Day Summary</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D3_Microlearning/chapter_title.html">Microlearning (W2D3)</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_Tutorial1.html">Tutorial 1: Microlearning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/further_reading.html">Suggested further readings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_DaySummary.html">Day Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D4_Macrolearning/chapter_title.html">Macrolearning (W2D4)</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial1.html">Tutorial 1: The problem of changing data distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial2.html">Tutorial 2: Continual learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial3.html">Tutorial 3: Meta-learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial4.html">Tutorial 4: Biological meta reinforcement learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial5.html">Tutorial 5: Replay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/further_reading.html">Suggested further readings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_DaySummary.html">Day Summary</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mysteries</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D5_Mysteries/chapter_title.html">Mysteries (W2D5)</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Tutorial1.html">Tutorial 1: Consciousness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Tutorial2.html">Tutorial 2: Ethics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Outro.html">Outro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/further_reading.html">Suggested further readings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_DaySummary.html">Day Summary</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project Booklet</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../projects/README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/docs/project_guidance.html">Daily guide for projects</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../projects/docs/datasets_overview.html">Project materials</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../projects/project-notebooks/Macrocircuits.html">Macrocircuits: leveraging neural architectural priors and modularity in embodied agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../projects/project-notebooks/Microlearning.html">Microlearning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../projects/project-notebooks/ComparingNetworks.html">Comparing networks: characterizing computational similarity in task-trained recurrent neural networks</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Professional Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/impact_talks.html">Impact Talks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/mentorship_program.html">Professional developemnt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/career_features.html">Career Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/career_panels.html">Career Panels</a></li>
</ul>
</div>
</nav>
</div>
</div>
<div class="sidebar-end-items sidebar-primary__section">
<div class="sidebar-end-items__item">
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="sidebar-toggle primary-toggle btn btn-sm" data-placement="right" data-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</label>
</div>
<div class="header-article__right">
<div class="dropdown dropdown-launch-buttons">
<button aria-expanded="false" aria-label="Launch interactive content" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-rocket"></i>
</button>
<ul class="dropdown-menu">
</ul>
</div>
<button class="btn btn-sm" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<div class="dropdown dropdown-repository-buttons">
<button aria-expanded="false" aria-label="Source repositories" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fab fa-github"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" href="https://github.com/neuromatch/NeuroAI_Course" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
<span class="btn__text-container">repository</span>
</a>

<li><a class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" href="https://github.com/neuromatch/NeuroAI_Course/issues/new?title=Issue%20on%20page%20%2Ftutorials/W1D1_Generalization/student/W1D1_Tutorial3.html&amp;body=Your%20issue%20content%20here." target="_blank" title="Open an issue">
<span class="btn__icon-container">
<i class="fas fa-lightbulb"></i>
</span>
<span class="btn__text-container">open issue</span>
</a>

</li></li></ul>
</div>
<div class="dropdown dropdown-download-buttons">
<button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-download"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" href="../../../_sources/tutorials/W1D1_Generalization/student/W1D1_Tutorial3.ipynb" target="_blank" title="Download source file">
<span class="btn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="btn__text-container">.ipynb</span>
</a>

<li>
<button class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="btn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="btn__text-container">.pdf</span>
</button>

</li></li></ul>
</div>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-placement="left" data-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</label>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>Tutorial 3: Generalization in Cognitive Science</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 3: Generalization in Cognitive Science
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#tutorial-objectives">
   Tutorial Objectives
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
   Setup
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#install-dependencies">
     Install dependencies
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#import-dependencies">
     Import dependencies
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions">
     Plotting functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-retrieval-for-zip-files">
     Data retrieval for zip files
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-retrieval-for-torch-models">
     Data retrieval for torch models
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#activity-1-exploring-the-omniglot-dataset">
     Activity 1: Exploring the Omniglot dataset
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-generalization-in-cognitive-science">
       Video 1: Generalization in Cognitive Science
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#reflection-activity">
     Reflection activity
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#submit-your-feedback">
       Submit your feedback
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#activity-2-building-alternative-bottom-up-parses">
     Activity 2: Building alternative bottom-up parses
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Submit your feedback
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#activity-3-building-a-single-stroke-model">
     Activity 3: Building a single stroke model
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#parameters">
       Parameters
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#broaden-and-blur">
       Broaden and Blur
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#hidden-methods-for-renderer-and-painter">
       Hidden methods for Renderer and Painter
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
       Submit your feedback
      </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<article class="bd-article" role="main">
<p><a href="https://colab.research.google.com/github/neuromatch/NeuroAI_Course/blob/main/tutorials/W1D1_Generalization/student/W1D1_Tutorial3.ipynb" target="_blank"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a>   <a href="https://kaggle.com/kernels/welcome?src=https://raw.githubusercontent.com/neuromatch/NeuroAI_Course/blob/main/tutorials/W1D1_Generalization/student/W1D1_Tutorial3.ipynb" target="_blank"><img alt="Open in Kaggle" src="https://kaggle.com/static/images/open-in-kaggle.svg"/></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="tutorial-3-generalization-in-cognitive-science">
<h1>Tutorial 3: Generalization in Cognitive Science<a class="headerlink" href="#tutorial-3-generalization-in-cognitive-science" title="Permalink to this heading">#</a></h1>
<p><strong>Week 1, Day 1: Generalization</strong></p>
<p><strong>By Neuromatch Academy</strong></p>
<p><strong>Content creators:</strong> Samuele Bolotta</p>
<p><strong>Content reviewers:</strong> Samuele Bolotta</p>
<p><strong>Production editors:</strong> Konstantine Tsafatinos, Ella Batty, Spiros Chavlis, Samuele Bolotta, Hlib Solodzhuk</p>
</section>
<hr class="docutils"/>
<section class="tex2jax_ignore mathjax_ignore" id="tutorial-objectives">
<h1>Tutorial Objectives<a class="headerlink" href="#tutorial-objectives" title="Permalink to this heading">#</a></h1>
<p><em>Estimated timing of tutorial: [insert estimated duration of whole tutorial in minutes]</em></p>
<p>By the end of this tutorial, participants will be able to:</p>
<ol class="arabic simple">
<li><p>Explore the goals of cognitive science. Understand the aims of cognitive science such as unraveling the complexities of human cognition.</p></li>
<li><p>Investigate core research areas. Delve into critical research areas including decision making, problem solving, learning, thinking, and perceiving.</p></li>
<li><p>Grasp the notion of generalization. Learn about generalization in cognitive science, with an emphasis on the human mind’s abilities and constraints in both controlled and natural settings.</p></li>
<li><p>Contrast historical cognitive approaches. Gain a perspective on historical cognitive approaches, specifically the connectionist and symbolic frameworks, and how symbolic approaches attempt to encode inductive biases.</p></li>
<li><p>Develop coding skills for cognitive modeling. Acquire practical coding experience by working on parts of cognitive models.</p></li>
</ol>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "277430fa110944e299d12d13b06f608c"}</script></div>
</div>
</section>
<hr class="docutils"/>
<section class="tex2jax_ignore mathjax_ignore" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h1>
<section id="install-dependencies">
<h2>Install dependencies<a class="headerlink" href="#install-dependencies" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install dependencies</span>
<span class="c1"># @markdown</span>

<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>matplotlib<span class="w"> </span>numpy<span class="w"> </span>Pillow<span class="w"> </span>scikit-image<span class="w"> </span>scikit-learn<span class="w"> </span>torch<span class="w"> </span>torchvision<span class="w"> </span>scipy<span class="w"> </span>ipywidgets<span class="w"> </span>tqdm

<span class="c1"># Install GNS and pyBPL</span>
<span class="c1">#!pip install git+https://github.com/neuromatch/GNS-Modeling</span>
<span class="c1">#!pip install git+https://github.com/neuromatch/pyBPL</span>
<span class="c1">#!pip install numba</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: matplotlib in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (3.8.3)
Requirement already satisfied: numpy in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (1.26.4)
Requirement already satisfied: Pillow in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (10.2.0)
Requirement already satisfied: scikit-image in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (0.19.2)
Requirement already satisfied: scikit-learn in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (1.4.1.post1)
Requirement already satisfied: torch in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (2.1.0)
Requirement already satisfied: torchvision in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (0.16.0)
Requirement already satisfied: scipy in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (1.12.0)
Requirement already satisfied: ipywidgets in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (8.1.2)
Requirement already satisfied: tqdm in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (4.66.2)
Requirement already satisfied: contourpy&gt;=1.0.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (1.2.1)
Requirement already satisfied: cycler&gt;=0.10 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (4.51.0)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (1.4.5)
Requirement already satisfied: packaging&gt;=20.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (24.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (3.1.2)
Requirement already satisfied: python-dateutil&gt;=2.7 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (2.9.0.post0)
Requirement already satisfied: importlib-resources&gt;=3.2.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from matplotlib) (6.4.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: networkx&gt;=2.2 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from scikit-image) (3.2.1)
Requirement already satisfied: imageio&gt;=2.4.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from scikit-image) (2.34.1)
Requirement already satisfied: tifffile&gt;=2019.7.26 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from scikit-image) (2024.5.10)
Requirement already satisfied: PyWavelets&gt;=1.1.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from scikit-image) (1.6.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: joblib&gt;=1.2.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from scikit-learn) (1.4.2)
Requirement already satisfied: threadpoolctl&gt;=2.0.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from scikit-learn) (3.5.0)
Requirement already satisfied: filelock in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (3.14.0)
Requirement already satisfied: typing-extensions in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (4.11.0)
Requirement already satisfied: sympy in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (1.12)
Requirement already satisfied: jinja2 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (3.1.4)
Requirement already satisfied: fsspec in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (2024.5.0)
Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (12.1.105)
Requirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (12.1.105)
Requirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (12.1.105)
Requirement already satisfied: nvidia-cudnn-cu12==8.9.2.26 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (8.9.2.26)
Requirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (12.1.3.1)
Requirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (11.0.2.54)
Requirement already satisfied: nvidia-curand-cu12==10.3.2.106 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (10.3.2.106)
Requirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (11.4.5.107)
Requirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (12.1.0.106)
Requirement already satisfied: nvidia-nccl-cu12==2.18.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (2.18.1)
Requirement already satisfied: nvidia-nvtx-cu12==12.1.105 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (12.1.105)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: triton==2.1.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torch) (2.1.0)
Requirement already satisfied: nvidia-nvjitlink-cu12 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from nvidia-cusolver-cu12==11.4.5.107-&gt;torch) (12.4.127)
Requirement already satisfied: requests in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from torchvision) (2.31.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: comm&gt;=0.1.3 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipywidgets) (0.2.2)
Requirement already satisfied: ipython&gt;=6.1.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipywidgets) (8.18.1)
Requirement already satisfied: traitlets&gt;=4.3.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipywidgets) (5.14.3)
Requirement already satisfied: widgetsnbextension~=4.0.10 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipywidgets) (4.0.10)
Requirement already satisfied: jupyterlab-widgets~=3.0.10 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipywidgets) (3.0.10)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: zipp&gt;=3.1.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from importlib-resources&gt;=3.2.0-&gt;matplotlib) (3.18.1)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: decorator in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (5.0.9)
Requirement already satisfied: jedi&gt;=0.16 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (0.19.1)
Requirement already satisfied: matplotlib-inline in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (0.1.7)
Requirement already satisfied: prompt-toolkit&lt;3.1.0,&gt;=3.0.41 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (3.0.43)
Requirement already satisfied: pygments&gt;=2.4.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (2.18.0)
Requirement already satisfied: stack-data in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (0.6.3)
Requirement already satisfied: exceptiongroup in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (1.2.1)
Requirement already satisfied: pexpect&gt;4.3 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from ipython&gt;=6.1.0-&gt;ipywidgets) (4.9.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: six&gt;=1.5 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib) (1.16.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: MarkupSafe&gt;=2.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from jinja2-&gt;torch) (2.1.5)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from requests-&gt;torchvision) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from requests-&gt;torchvision) (3.7)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from requests-&gt;torchvision) (2.2.1)
Requirement already satisfied: certifi&gt;=2017.4.17 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from requests-&gt;torchvision) (2024.2.2)
Requirement already satisfied: mpmath&gt;=0.19 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from sympy-&gt;torch) (1.3.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: parso&lt;0.9.0,&gt;=0.8.3 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from jedi&gt;=0.16-&gt;ipython&gt;=6.1.0-&gt;ipywidgets) (0.8.4)
Requirement already satisfied: ptyprocess&gt;=0.5 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from pexpect&gt;4.3-&gt;ipython&gt;=6.1.0-&gt;ipywidgets) (0.7.0)
Requirement already satisfied: wcwidth in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from prompt-toolkit&lt;3.1.0,&gt;=3.0.41-&gt;ipython&gt;=6.1.0-&gt;ipywidgets) (0.2.13)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: executing&gt;=1.2.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from stack-data-&gt;ipython&gt;=6.1.0-&gt;ipywidgets) (2.0.1)
Requirement already satisfied: asttokens&gt;=2.1.0 in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from stack-data-&gt;ipython&gt;=6.1.0-&gt;ipywidgets) (2.4.1)
Requirement already satisfied: pure-eval in /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages (from stack-data-&gt;ipython&gt;=6.1.0-&gt;ipywidgets) (0.2.2)
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-dependencies">
<h2>Import dependencies<a class="headerlink" href="#import-dependencies" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Import dependencies</span>
<span class="c1"># @markdown</span>

<span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>

<span class="c1"># Data handling and visualization</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">skimage</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Deep Learning libraries</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToPILImage</span>

<span class="c1"># Interactive controls in Jupyter notebooks</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>

<span class="c1"># Libraries for specific tasks related to gns and pybpl</span>
<span class="kn">import</span> <span class="nn">gns</span>
<span class="kn">from</span> <span class="nn">gns</span> <span class="kn">import</span> <span class="n">MODEL_SAVE_PATH</span>
<span class="kn">from</span> <span class="nn">gns.inference.parsing</span> <span class="kn">import</span> <span class="n">get_topK_parses</span>
<span class="kn">from</span> <span class="nn">gns.omniglot.classification</span> <span class="kn">import</span> <span class="n">ClassificationDataset</span>
<span class="kn">from</span> <span class="nn">gns.rendering</span> <span class="kn">import</span> <span class="n">Renderer</span> <span class="k">as</span> <span class="n">DefaultRenderer</span>
<span class="kn">from</span> <span class="nn">gns.type</span> <span class="kn">import</span> <span class="n">TypeModel</span>
<span class="kn">from</span> <span class="nn">gns.utils.experiments</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">time_string</span>
<span class="kn">import</span> <span class="nn">pybpl</span>
<span class="kn">from</span> <span class="nn">pybpl</span> <span class="kn">import</span> <span class="n">splines</span><span class="p">,</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">pybpl.util</span> <span class="kn">import</span> <span class="n">nested_map</span>
<span class="kn">from</span> <span class="nn">pybpl.util.stroke</span> <span class="kn">import</span> <span class="n">dist_along_traj</span>
<span class="kn">from</span> <span class="nn">pybpl.util.general</span> <span class="kn">import</span> <span class="n">fspecial</span>

<span class="c1"># Utility for progress bars</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Reload gns</span>
<span class="n">reload</span><span class="p">(</span><span class="n">gns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;module 'gns' from '/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/__init__.py'&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="figure-settings">
<h2>Figure settings<a class="headerlink" href="#figure-settings" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Figure settings</span>
<span class="c1"># @markdown</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">'matplotlib.font_manager'</span><span class="p">)</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = 'retina' # perfrom high definition rendering for images and plots
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/NeuromatchAcademy/course-content/main/nma.mplstyle"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="plotting-functions">
<h2>Plotting functions<a class="headerlink" href="#plotting-functions" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Plotting functions</span>
<span class="c1"># @markdown</span>

<span class="k">def</span> <span class="nf">display_images</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="c1"># Open the probe image and the option images</span>
    <span class="n">probe_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">probe</span><span class="p">)</span>
    <span class="n">option_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>

    <span class="c1"># Create a figure with the probe and the 3x3 grid for the options directly below</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Adjust figure size as needed</span>

    <span class="c1"># Add the probe image to the top of the figure with a red border</span>
    <span class="n">ax_probe</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Span the probe across the top 3 columns</span>
    <span class="n">ax_probe</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">probe_image</span><span class="p">)</span>
    <span class="n">ax_probe</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">probe_image</span><span class="o">.</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">probe_image</span><span class="o">.</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">'none'</span><span class="p">)</span>
    <span class="n">ax_probe</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

    <span class="c1"># Position the 3x3 grid of option images directly below the probe image</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">option_images</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Calculate row in the 3x3 grid, starting directly below the probe</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># Calculate column in the 3x3 grid</span>
        <span class="n">ax_option</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">row</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">col</span><span class="p">)</span>  <span class="c1"># Adjust grid position to directly follow the probe</span>
        <span class="n">ax_option</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">ax_option</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="data-retrieval-for-zip-files">
<h2>Data retrieval for zip files<a class="headerlink" href="#data-retrieval-for-zip-files" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Data retrieval for zip files</span>
<span class="c1"># @markdown</span>

<span class="k">def</span> <span class="nf">handle_file_operations</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">expected_md5</span><span class="p">,</span> <span class="n">extract_to</span><span class="o">=</span><span class="s1">'data'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Handles downloading, verifying, and extracting a file."""</span>

    <span class="c1"># Define helper functions for download, verify, and extract operations</span>
    <span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Downloads file from the given URL and saves it locally."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                    <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Download successful."</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"!!! Failed to download data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> !!!"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">verify_file_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">expected_md5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Verifies the file's MD5 checksum."""</span>
        <span class="n">hash_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">""</span><span class="p">):</span>
                <span class="n">hash_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hash_md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected_md5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"MD5 checksum verified."</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"!!! Data download appears corrupted !!!"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">extract_zip_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">extract_to</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Extracts the ZIP file to the specified directory."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
                <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_to</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File extracted successfully to </span><span class="si">{</span><span class="n">extract_to</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipFile</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"!!! The ZIP file is corrupted or not a zip file !!!"</span><span class="p">)</span>

    <span class="c1"># Main operation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">verify_file_md5</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">expected_md5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verify_file_md5</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">expected_md5</span><span class="p">):</span>
            <span class="n">extract_zip_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">extract_to</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File '</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">' already exists and is verified. Proceeding to extraction."</span><span class="p">)</span>
        <span class="n">extract_zip_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">extract_to</span><span class="p">)</span>

<span class="c1"># Example usage</span>
<span class="n">file_info</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">"fname"</span><span class="p">:</span> <span class="s2">"one-shot-classification.zip"</span><span class="p">,</span> <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"https://osf.io/aw6eq/download"</span><span class="p">,</span> <span class="s2">"expected_md5"</span><span class="p">:</span> <span class="s2">"9376412e7fb74d64f045644b51e641a6"</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"fname"</span><span class="p">:</span> <span class="s2">"omniglot-py.zip"</span><span class="p">,</span> <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"https://osf.io/bazxp/download"</span><span class="p">,</span> <span class="s2">"expected_md5"</span><span class="p">:</span> <span class="s2">"f7a4011f5c25460c6d95ee1428e377ed"</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"fname"</span><span class="p">:</span> <span class="s2">"parses.zip"</span><span class="p">,</span> <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"https://osf.io/97bpq/download"</span><span class="p">,</span> <span class="s2">"expected_md5"</span><span class="p">:</span> <span class="s2">"f9e42660d860d1f95296a3729e4bd2e3"</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"fname"</span><span class="p">:</span> <span class="s2">"targets.zip"</span><span class="p">,</span> <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"https://osf.io/stk9f/download"</span><span class="p">,</span> <span class="s2">"expected_md5"</span><span class="p">:</span> <span class="s2">"38bbf4a87910fe56a02ee7a77a9ded3e"</span><span class="p">}</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_info</span><span class="p">:</span>
    <span class="n">handle_file_operations</span><span class="p">(</span><span class="o">**</span><span class="n">file</span><span class="p">)</span>

<span class="c1">#Current directory</span>
<span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Download successful.
MD5 checksum verified.
File extracted successfully to data
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Download successful.
MD5 checksum verified.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File extracted successfully to data
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Download successful.
MD5 checksum verified.
File extracted successfully to data
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Download successful.
MD5 checksum verified.
File extracted successfully to data
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-retrieval-for-torch-models">
<h2>Data retrieval for torch models<a class="headerlink" href="#data-retrieval-for-torch-models" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Data retrieval for torch models</span>
<span class="c1"># @markdown</span>

<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Download a file from a given URL and save it in the specified directory.</span>
<span class="sd">    """</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  <span class="c1"># Ensure the file is saved in base_dir</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># Check for HTTP request errors</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">verify_checksum</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">expected_checksum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Verify the MD5 checksum of a file</span>

<span class="sd">    Parameters:</span>
<span class="sd">    filename (str): Path to the file</span>
<span class="sd">    expected_checksum (str): Expected MD5 checksum</span>

<span class="sd">    Returns:</span>
<span class="sd">    bool: True if the checksum matches, False otherwise</span>
<span class="sd">    """</span>
    <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">""</span><span class="p">):</span>
            <span class="n">md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected_checksum</span>

<span class="k">def</span> <span class="nf">load_models</span><span class="p">(</span><span class="n">model_files</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Load multiple models from a specified directory.</span>
<span class="sd">    """</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model_file</span> <span class="ow">in</span> <span class="n">model_files</span><span class="p">:</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>  <span class="c1"># Correctly join paths</span>
        <span class="n">models</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">models</span>

<span class="k">def</span> <span class="nf">verify_models_in_destination</span><span class="p">(</span><span class="n">model_files</span><span class="p">,</span> <span class="n">destination_directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Verify the presence of model files in the specified directory.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    model_files (list of str): Filenames of the models to verify.</span>
<span class="sd">    destination_directory (str): The directory where the models are supposed to be.</span>

<span class="sd">    Returns:</span>
<span class="sd">    bool: True if all models are found in the directory, False otherwise.</span>
<span class="sd">    """</span>
    <span class="n">missing_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">model_file</span> <span class="ow">in</span> <span class="n">model_files</span><span class="p">:</span>
        <span class="c1"># Construct the full path to where the model should be</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_directory</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
        <span class="c1"># Check if the model exists at the location</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
            <span class="n">missing_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">missing_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Missing model files in destination: </span><span class="si">{</span><span class="n">missing_files</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"All models are correctly located in the destination directory."</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># URLs and checksums for the models</span>
<span class="n">models_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'location_model.pt'</span><span class="p">:</span> <span class="p">(</span><span class="s1">'https://osf.io/zmd7y/download'</span><span class="p">,</span> <span class="s1">'dfd51cf7c3a277777ad941c4fcc23813'</span><span class="p">),</span>
    <span class="s1">'stroke_model.pt'</span><span class="p">:</span> <span class="p">(</span><span class="s1">'https://osf.io/m6yc7/download'</span><span class="p">,</span> <span class="s1">'511ea7bd12566245d5d11a85d5a0abb0'</span><span class="p">),</span>
    <span class="s1">'terminate_model.pt'</span><span class="p">:</span> <span class="p">(</span><span class="s1">'https://osf.io/dsmhc/download'</span><span class="p">,</span> <span class="s1">'2f3e26cfcf36ce9f9172c15d8b1079d1'</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">destination_directory</span> <span class="o">=</span> <span class="n">base_dir</span>

<span class="c1"># Define model_files based on the keys of models_info to ensure we have the filenames</span>
<span class="n">model_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">models_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Iterate over the models to download and verify</span>
<span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">checksum</span><span class="p">)</span> <span class="ow">in</span> <span class="n">models_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>  <span class="c1"># Downloads directly into base_dir</span>
    <span class="k">if</span> <span class="n">verify_checksum</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">checksum</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Successfully verified </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Checksum does not match for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. Download might be corrupted."</span><span class="p">)</span>

<span class="c1"># Verify the presence of the models in the destination directory</span>
<span class="k">if</span> <span class="n">verify_models_in_destination</span><span class="p">(</span><span class="n">model_files</span><span class="p">,</span> <span class="n">destination_directory</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Verification successful: All models are in the correct directory."</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Verification failed: Some models are missing from the destination directory."</span><span class="p">)</span>

<span class="c1"># Load the models from the destination directory</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">load_models</span><span class="p">(</span><span class="n">model_files</span><span class="p">,</span> <span class="n">destination_directory</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully verified location_model.pt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully verified stroke_model.pt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully verified terminate_model.pt
All models are correctly located in the destination directory.
Verification successful: All models are in the correct directory.
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions">
<h2>Helper functions<a class="headerlink" href="#helper-functions" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper functions</span>
<span class="c1"># @markdown</span>

<span class="k">def</span> <span class="nf">check_float_tesnor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">drawings_to_cpu</span><span class="p">(</span><span class="n">drawings</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drawings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">drawings</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">drawings</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stk</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="k">for</span> <span class="n">stk</span> <span class="ow">in</span> <span class="n">drawing</span><span class="p">]</span> <span class="k">for</span> <span class="n">drawing</span> <span class="ow">in</span> <span class="n">drawings</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">drawings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
        <span class="n">drawings</span> <span class="o">=</span> <span class="p">[</span><span class="n">stk</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="k">for</span> <span class="n">stk</span> <span class="ow">in</span> <span class="n">drawings</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">drawings</span>

<span class="k">def</span> <span class="nf">broaden_filter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">a</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">12</span><span class="p">],</span>
         <span class="p">[</span><span class="n">a</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">6</span><span class="p">],</span>
         <span class="p">[</span><span class="n">a</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">12</span><span class="p">]],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
        <span class="n">device</span><span class="o">=</span><span class="n">device</span>
    <span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">H</span>

<span class="k">def</span> <span class="nf">blur_filter</span><span class="p">(</span><span class="n">fsize</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">fspecial</span><span class="p">(</span><span class="n">fsize</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">'gaussian'</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">H</span>

<span class="k">def</span> <span class="nf">check_float_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">select_random_images_within_alphabet</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">alphabet_path</span><span class="p">,</span> <span class="n">exclude_character_path</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">chosen_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_characters</span> <span class="o">=</span> <span class="p">[</span><span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">alphabet_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alphabet_path</span><span class="p">,</span> <span class="n">char</span><span class="p">))</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alphabet_path</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span> <span class="o">!=</span> <span class="n">exclude_character_path</span><span class="p">]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_images</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_images</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_characters</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">character</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_characters</span><span class="p">)</span>
        <span class="n">character_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alphabet_path</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span>
        <span class="n">all_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">character_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.png'</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_images</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_images</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">character_path</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
        <span class="n">chosen_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chosen_images</span>

<span class="k">def</span> <span class="nf">run_trial</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">num_trials</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">[</span><span class="n">lang</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">lang</span><span class="p">))]</span>
        <span class="n">selected_language</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">languages</span><span class="p">)</span>
        <span class="n">language_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">selected_language</span><span class="p">)</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="p">[</span><span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">language_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">language_path</span><span class="p">,</span> <span class="n">char</span><span class="p">))]</span>
        <span class="n">selected_character</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span>
        <span class="n">character_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">language_path</span><span class="p">,</span> <span class="n">selected_character</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">character_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.png'</span><span class="p">)]</span>
        <span class="n">probe_image_path</span><span class="p">,</span> <span class="n">correct_answer_image_path</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">probe_image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">character_path</span><span class="p">,</span> <span class="n">probe_image_path</span><span class="p">)</span>
        <span class="n">correct_answer_image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">character_path</span><span class="p">,</span> <span class="n">correct_answer_image_path</span><span class="p">)</span>
        <span class="n">wrong_answers</span> <span class="o">=</span> <span class="n">select_random_images_within_alphabet</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">language_path</span><span class="p">,</span> <span class="n">character_path</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">wrong_answers</span>
        <span class="n">options</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)),</span> <span class="n">correct_answer_image_path</span><span class="p">)</span>
        <span class="n">display_images</span><span class="p">(</span><span class="n">probe_image_path</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="activity-1-exploring-the-omniglot-dataset">
<h2>Activity 1: Exploring the Omniglot dataset<a class="headerlink" href="#activity-1-exploring-the-omniglot-dataset" title="Permalink to this heading">#</a></h2>
<section id="video-1-generalization-in-cognitive-science">
<h3>Video 1: Generalization in Cognitive Science<a class="headerlink" href="#video-1-generalization-in-cognitive-science" title="Permalink to this heading">#</a></h3>
<div class="cell tag_remove-input docutils container">
</div>
<p>The goal of this section is to interact with a simple widget to perform the categorization task in Lake et al. (2015). We start by loading some data.</p>
<p>Your task is to conduct a series of trials to explore the Omniglot dataset, focusing on its structure and diversity of characters. Specifically, the function will randomly selecting languages, characters, and images to create a simple recognition task. Here’s a breakdown of what will happen:</p>
<ol class="arabic simple">
<li><p><strong>Navigate through the Omniglot dataset</strong>: the function will start by accessing the Omniglot dataset.</p></li>
<li><p><strong>Select random characters and images</strong>: for each trial, it’ll randomly pick a language, then a character within that language, and finally two images of that character. These images serve as the “probe” and “correct answer” in your recognition task.</p></li>
<li><p><strong>Generate wrong answers</strong>: to create a challenging task, it’ll also select additional images from the same language but different characters to serve as wrong answers.</p></li>
<li><p><strong>Display the task</strong>: it’ll arrange the correct answer among the wrong ones and present them alongside the probe image. This setup tests your ability to recognize variations of a character amidst similar but incorrect options.</p></li>
<li><p><strong>Repeat for multiple trials</strong>: this process is repeated for a specified number of trials, each time selecting new characters and images to maintain the challenge’s novelty and test the dataset’s variety.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Paths</span>
<span class="n">base_path</span> <span class="o">=</span> <span class="s2">"data/omniglot-py/images_background"</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we interact with the widget. This is a categorization task. You need to match the prompt (surrounded by a red square) with one of the six options based on the category.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running the trial</span>
<span class="n">run_trial</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">num_trials</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/ab5dcf87aed0e4b7869579a6a1c28f1b1942a4568be6df702ad53f82a90b926f.png" src="../../../_images/ab5dcf87aed0e4b7869579a6a1c28f1b1942a4568be6df702ad53f82a90b926f.png">
<img alt="../../../_images/18786e39d684f8ccab16a9b1fa5df7f99cc4d42483960029fbac0b808509f1cb.png" src="../../../_images/18786e39d684f8ccab16a9b1fa5df7f99cc4d42483960029fbac0b808509f1cb.png">
<img alt="../../../_images/07090dac30c8f3158c4bc3353f2a10e0addbeae2c89de6d6be1fed7e88c260c9.png" src="../../../_images/07090dac30c8f3158c4bc3353f2a10e0addbeae2c89de6d6be1fed7e88c260c9.png"/>
</img></img></div>
</div>
</section>
</section>
<section id="reflection-activity">
<h2>Reflection activity<a class="headerlink" href="#reflection-activity" title="Permalink to this heading">#</a></h2>
<p>How do you think you, as a human, are performing a task like Omniglot?</p>
<section id="submit-your-feedback">
<h3>Submit your feedback<a class="headerlink" href="#submit-your-feedback" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Submit your feedback</span>
<span class="c1"># content_review(f"{feedback_prefix}_Omniglot_Exercise")</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="activity-2-building-alternative-bottom-up-parses">
<h2>Activity 2: Building alternative bottom-up parses<a class="headerlink" href="#activity-2-building-alternative-bottom-up-parses" title="Permalink to this heading">#</a></h2>
<p>Now, we build a widget that uses the sample bottom up parsing script to build alternative bottom up parses.</p>
<p>In Activity 2, you will use a script for bottom-up parsing to create alternative parses for images. This involves:</p>
<ul class="simple">
<li><p><strong>Model score function</strong>: calculates scores for parses by transforming spline representations into strokes, evaluating them on a model, and inversely relating the scores to model losses.</p></li>
<li><p><strong>Collect image results</strong>: organizes parses and their log probabilities in a structured format for analysis or visualization, bypassing the need for disk storage.</p></li>
<li><p><strong>Get base parses in memory</strong>: initializes a model and dataset, then computes top-K parses for each image based on model scoring. It emphasizes the generation of alternative interpretations without minor detail consideration.</p></li>
<li><p><strong>Visualize parses</strong>: displays the reference image alongside alternative parses, illustrating the model’s ability to capture diverse interpretations.</p></li>
</ul>
<p>The process entails scoring parses, collecting data, generating alternative interpretations, and visualizing results to understand the model’s generative capabilities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">model_score_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parses</span><span class="p">):</span>
    <span class="n">drawings</span> <span class="o">=</span> <span class="n">nested_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">splines</span><span class="o">.</span><span class="n">get_stk_from_bspline</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">parses</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">drawings</span> <span class="o">=</span> <span class="n">nested_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">drawings</span><span class="p">)</span>
        <span class="n">parses</span> <span class="o">=</span> <span class="n">nested_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">parses</span><span class="p">)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">losses_fn</span><span class="p">(</span><span class="n">parses</span><span class="p">,</span> <span class="n">drawings</span><span class="p">,</span> <span class="n">filter_small</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">denormalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">losses</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">collect_img_results</span><span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="n">parses</span><span class="p">,</span> <span class="n">log_probs</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Collects parses and log probabilities without saving to disk."""</span>
    <span class="n">appendix</span> <span class="o">=</span> <span class="s1">'test'</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="s1">'train'</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'img_id'</span><span class="p">:</span> <span class="n">img_id</span><span class="p">,</span>
        <span class="s1">'appendix'</span><span class="p">:</span> <span class="n">appendix</span><span class="p">,</span>
        <span class="s1">'parses'</span><span class="p">:</span> <span class="n">parses</span><span class="p">,</span>
        <span class="s1">'log_probs'</span><span class="p">:</span> <span class="n">log_probs</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">get_base_parses_in_memory</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">trials_per</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'run_id: </span><span class="si">%i</span><span class="s1">'</span> <span class="o">%</span> <span class="n">run_id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Loading model...'</span><span class="p">)</span>
    <span class="c1"># Correctly identify the base directory of the `gns` package</span>
    <span class="n">gns_base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">gns</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

    <span class="c1"># Specify the model save directory within the `gns` package</span>
    <span class="n">model_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gns_base_dir</span><span class="p">,</span> <span class="s1">'model_saves'</span><span class="p">)</span>

    <span class="c1"># Initialize TypeModel</span>
    <span class="n">type_model</span> <span class="o">=</span> <span class="n">TypeModel</span><span class="p">()</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">type_model</span> <span class="o">=</span> <span class="n">type_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="n">score_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">parses</span><span class="p">:</span> <span class="n">model_score_fn</span><span class="p">(</span><span class="n">type_model</span><span class="p">,</span> <span class="n">parses</span><span class="p">)</span>

    <span class="c1"># Use the dynamically determined path</span>
    <span class="n">osc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">'data/one-shot-classification'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Loading classification dataset...'</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ClassificationDataset</span><span class="p">(</span><span class="n">osc_folder</span><span class="o">=</span><span class="n">osc_path</span><span class="p">)</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="n">run_id</span><span class="p">]</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">test_imgs</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="n">run</span><span class="o">.</span><span class="n">train_imgs</span>

    <span class="n">collected_data</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># In-memory storage for parses and log_probs</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'Collecting top-K parses for each train image...'</span><span class="p">)</span>
    <span class="n">nimg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimg</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">parses</span><span class="p">,</span> <span class="n">log_probs</span> <span class="o">=</span> <span class="n">get_topK_parses</span><span class="p">(</span>
            <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_fn</span><span class="o">=</span><span class="n">score_fn</span><span class="p">,</span> <span class="n">configs_per</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">trials_per</span><span class="o">=</span><span class="n">trials_per</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">nimg</span><span class="si">}</span><span class="s1"> took </span><span class="si">{</span><span class="n">time_string</span><span class="p">(</span><span class="n">total_time</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">img_results</span> <span class="o">=</span> <span class="n">collect_img_results</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">parses</span><span class="p">,</span> <span class="n">log_probs</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="n">collected_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">collected_data</span>

<span class="c1"># Example usage</span>
<span class="n">run_id</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">trials_per</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">reverse</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Call the function</span>
<span class="n">collected_data</span> <span class="o">=</span> <span class="n">get_base_parses_in_memory</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">trials_per</span><span class="o">=</span><span class="n">trials_per</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>run_id: 10
Loading model...
Loading classification dataset...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting top-K parses for each train image...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 1/20 took 0:00:12
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 2/20 took 0:00:30
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 3/20 took 0:00:02
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 4/20 took 0:00:14
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 5/20 took 0:00:03
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 6/20 took 0:02:44
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 7/20 took 0:00:04
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 8/20 took 0:00:21
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image 9/20 took 0:00:02
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">line</span> <span class="mi">69</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span> <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span> <span class="c1"># Call the function</span>
<span class="ne">---&gt; </span><span class="mi">69</span> <span class="n">collected_data</span> <span class="o">=</span> <span class="n">get_base_parses_in_memory</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">trials_per</span><span class="o">=</span><span class="n">trials_per</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>

<span class="nn">Cell In[13], line 50,</span> in <span class="ni">get_base_parses_in_memory</span><span class="nt">(run_id, trials_per, reverse, dry_run)</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimg</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span>     <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">50</span>     <span class="n">parses</span><span class="p">,</span> <span class="n">log_probs</span> <span class="o">=</span> <span class="n">get_topK_parses</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>         <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">score_fn</span><span class="o">=</span><span class="n">score_fn</span><span class="p">,</span> <span class="n">configs_per</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>         <span class="n">trials_per</span><span class="o">=</span><span class="n">trials_per</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>     <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">nimg</span><span class="si">}</span><span class="s1"> took </span><span class="si">{</span><span class="n">time_string</span><span class="p">(</span><span class="n">total_time</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/inference/parsing/top_k.py:76,</span> in <span class="ni">get_topK_parses</span><span class="nt">(img, k, score_fn, configs_per, trials_per, device, seed, **grp_kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span> <span class="n">parses</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">log_probs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">     </span><span class="mi">75</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">76</span>     <span class="n">parses_i</span><span class="p">,</span> <span class="n">log_probs_i</span> <span class="o">=</span> <span class="n">search_parse</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">77</span>         <span class="n">base_parses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">score_fn</span><span class="p">,</span> <span class="n">configs_per</span><span class="p">,</span> <span class="n">trials_per</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">78</span>     <span class="n">parses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parses_i</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span>     <span class="n">log_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_probs_i</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/inference/parsing/top_k.py:58,</span> in <span class="ni">search_parse</span><span class="nt">(parse, score_fn, configs_per, trials_per)</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span> <span class="c1"># score configurations and take top-(configs_per)</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span> <span class="n">parses</span> <span class="o">=</span> <span class="p">[</span><span class="n">apply_config</span><span class="p">(</span><span class="n">parse</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">]</span>
<span class="ne">---&gt; </span><span class="mi">58</span> <span class="n">log_probs</span> <span class="o">=</span> <span class="n">score_fn</span><span class="p">(</span><span class="n">parses</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span> <span class="n">log_probs</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span> <span class="n">parses</span> <span class="o">=</span> <span class="p">[</span><span class="n">parses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>

<span class="nn">Cell In[13], line 35,</span> in <span class="ni">get_base_parses_in_memory.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(parses)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span>     <span class="n">type_model</span> <span class="o">=</span> <span class="n">type_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">35</span> <span class="n">score_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">parses</span><span class="p">:</span> <span class="n">model_score_fn</span><span class="p">(</span><span class="n">type_model</span><span class="p">,</span> <span class="n">parses</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="c1"># Use the dynamically determined path</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span> <span class="n">osc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">'data/one-shot-classification'</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/utils/_contextlib.py:115,</span> in <span class="ni">context_decorator.&lt;locals&gt;.decorate_context</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span> <span class="k">def</span> <span class="nf">decorate_context</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>     <span class="k">with</span> <span class="n">ctx_factory</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">115</span>         <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">Cell In[13], line 7,</span> in <span class="ni">model_score_fn</span><span class="nt">(model, parses)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">drawings</span> <span class="o">=</span> <span class="n">nested_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">drawings</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">parses</span> <span class="o">=</span> <span class="n">nested_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">parses</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">losses_fn</span><span class="p">(</span><span class="n">parses</span><span class="p">,</span> <span class="n">drawings</span><span class="p">,</span> <span class="n">filter_small</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">denormalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="k">return</span> <span class="o">-</span><span class="n">losses</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/type/model.py:183,</span> in <span class="ni">TypeModel.losses_fn</span><span class="nt">(self, splines_list, drawing_list, filter_small, denormalize, max_size)</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">splines_list</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">max_size</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">183</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_losses_fn</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span>         <span class="n">splines_list</span><span class="p">,</span> <span class="n">drawing_list</span><span class="p">,</span> <span class="n">filter_small</span><span class="p">,</span> <span class="n">denormalize</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">splines_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> <span class="n">nbatch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">max_size</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/type/model.py:160,</span> in <span class="ni">TypeModel._losses_fn</span><span class="nt">(self, splines_list, drawing_list, filter_small, denormalize)</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span> <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ns</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">ns_list</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">159</span> <span class="k">if</span> <span class="n">denormalize</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">160</span>     <span class="n">losses_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">losses_fn</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span>         <span class="n">x_canv</span><span class="o">=</span><span class="n">canvases</span><span class="p">,</span> <span class="n">prev</span><span class="o">=</span><span class="n">prevs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">locs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">162</span>         <span class="n">mean_X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_mean</span><span class="p">,</span> <span class="n">std_X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_scale</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">163</span>     <span class="n">losses_stk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stk</span><span class="o">.</span><span class="n">losses_fn</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span>         <span class="n">x_canv</span><span class="o">=</span><span class="n">canvases</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">locs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">trajs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">165</span>         <span class="n">std_X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_scale</span>
<span class="g g-Whitespace">    </span><span class="mi">166</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">167</span> <span class="k">else</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/type/location_model.py:118,</span> in <span class="ni">CNNStart.losses_fn</span><span class="nt">(self, x_canv, start, prev, mean_X, std_X)</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span> <span class="k">def</span> <span class="nf">losses_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_canv</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">mean_X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std_X</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># forward model</span>
<span class="ne">--&gt; </span><span class="mi">118</span>     <span class="n">start_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x_canv</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span>     <span class="c1"># apply de-normalize</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">if</span> <span class="p">(</span><span class="n">mean_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">std_X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/gns/type/location_model.py:84,</span> in <span class="ni">CNNStart.forward</span><span class="nt">(self, x, prev)</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span>     <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">83</span> <span class="n">x</span> <span class="o">=</span> <span class="n">zscore_canvases</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">84</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># (n,64,1,1)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (n,64)</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span> <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">prev</span><span class="p">],</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># (n,64+2)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/module.py:1518,</span> in <span class="ni">Module._wrapped_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1516</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
<span class="g g-Whitespace">   </span><span class="mi">1517</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1518</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/module.py:1527,</span> in <span class="ni">Module._call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1522</span> <span class="c1"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="g g-Whitespace">   </span><span class="mi">1523</span> <span class="c1"># this function, and just call forward.</span>
<span class="g g-Whitespace">   </span><span class="mi">1524</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backward_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backward_pre_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1525</span>         <span class="ow">or</span> <span class="n">_global_backward_pre_hooks</span> <span class="ow">or</span> <span class="n">_global_backward_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1526</span>         <span class="ow">or</span> <span class="n">_global_forward_hooks</span> <span class="ow">or</span> <span class="n">_global_forward_pre_hooks</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1527</span>     <span class="k">return</span> <span class="n">forward_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1529</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1530</span>     <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/container.py:215,</span> in <span class="ni">Sequential.forward</span><span class="nt">(self, input)</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span> <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>     <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">215</span>         <span class="nb">input</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="k">return</span> <span class="nb">input</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/module.py:1518,</span> in <span class="ni">Module._wrapped_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1516</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
<span class="g g-Whitespace">   </span><span class="mi">1517</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1518</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/module.py:1527,</span> in <span class="ni">Module._call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1522</span> <span class="c1"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="g g-Whitespace">   </span><span class="mi">1523</span> <span class="c1"># this function, and just call forward.</span>
<span class="g g-Whitespace">   </span><span class="mi">1524</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backward_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backward_pre_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1525</span>         <span class="ow">or</span> <span class="n">_global_backward_pre_hooks</span> <span class="ow">or</span> <span class="n">_global_backward_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1526</span>         <span class="ow">or</span> <span class="n">_global_forward_hooks</span> <span class="ow">or</span> <span class="n">_global_forward_pre_hooks</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1527</span>     <span class="k">return</span> <span class="n">forward_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1529</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1530</span>     <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/container.py:215,</span> in <span class="ni">Sequential.forward</span><span class="nt">(self, input)</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span> <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>     <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">215</span>         <span class="nb">input</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="k">return</span> <span class="nb">input</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/module.py:1518,</span> in <span class="ni">Module._wrapped_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1516</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
<span class="g g-Whitespace">   </span><span class="mi">1517</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1518</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/module.py:1527,</span> in <span class="ni">Module._call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1522</span> <span class="c1"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="g g-Whitespace">   </span><span class="mi">1523</span> <span class="c1"># this function, and just call forward.</span>
<span class="g g-Whitespace">   </span><span class="mi">1524</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backward_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backward_pre_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_hooks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_pre_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1525</span>         <span class="ow">or</span> <span class="n">_global_backward_pre_hooks</span> <span class="ow">or</span> <span class="n">_global_backward_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1526</span>         <span class="ow">or</span> <span class="n">_global_forward_hooks</span> <span class="ow">or</span> <span class="n">_global_forward_pre_hooks</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1527</span>     <span class="k">return</span> <span class="n">forward_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1529</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1530</span>     <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/torch/nn/modules/activation.py:356,</span> in <span class="ni">Tanh.forward</span><span class="nt">(self, input)</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span> <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">356</span>     <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use retina mode for matplotlib</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = 'retina'

<span class="c1"># Function to visualize parses</span>
<span class="k">def</span> <span class="nf">visualize_parses</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">collected_data</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">run</span><span class="p">):</span>
    <span class="c1"># Load the classification labels to map test images to their corresponding training images</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">'./data/one-shot-classification/all_runs/run</span><span class="si">{</span><span class="n">run</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">02</span><span class="si">}</span><span class="s1">/class_labels.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">test_to_train</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span>
        <span class="n">test_to_train</span><span class="p">[</span><span class="n">left</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
    <span class="n">train_im</span> <span class="o">=</span> <span class="n">test_to_train</span><span class="p">[</span><span class="sa">f</span><span class="s1">'item</span><span class="si">{</span><span class="n">item</span><span class="si">:</span><span class="s1">02</span><span class="si">}</span><span class="s1">.png'</span><span class="p">]</span>

    <span class="c1"># Reference image visualization</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">f</span><span class="s1">'./data/one-shot-classification/all_runs/run</span><span class="si">{</span><span class="n">run</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">02</span><span class="si">}</span><span class="s1">/training/</span><span class="si">{</span><span class="n">train_im</span><span class="si">}</span><span class="s1">'</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Reference image'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

    <span class="c1"># Load parses from the collected data</span>
    <span class="k">for</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="n">collected_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">'img_id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parses</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">'parses'</span><span class="p">]</span>
            <span class="k">break</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">renderer</span><span class="p">()</span>
    <span class="c1"># Visualization of parses</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parse</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parses</span><span class="p">):</span>
        <span class="n">drawings</span> <span class="o">=</span> <span class="p">[</span><span class="n">splines</span><span class="o">.</span><span class="n">get_stk_from_bspline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="n">drawings</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Parse </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'r'</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'m'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'k'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drawings</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'w.'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">'none'</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'ws'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">'none'</span><span class="p">)</span>

<span class="c1"># Example of visualizing parses for a specific item and run</span>
<span class="n">visualize_parses</span><span class="p">(</span><span class="n">DefaultRenderer</span><span class="p">,</span> <span class="n">collected_data</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>Submit your feedback<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Submit your feedback</span>
<span class="c1"># content_review(f"{feedback_prefix}_Visualize_Parses_Exercise")</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="activity-3-building-a-single-stroke-model">
<h2>Activity 3: Building a single stroke model<a class="headerlink" href="#activity-3-building-a-single-stroke-model" title="Permalink to this heading">#</a></h2>
<p>Build parts of the forward model necessary to build a differentiable renderer for a single stroke</p>
<p>In activity 3, you are tasked with constructing the forward model components necessary for a differentiable renderer focused on rendering single strokes. Parameters that will govern the rendering process are already initialized - parameters that define the image size and characteristics of ink distribution on the canvas, spline parameters for trajectory creation, image modeling parameters to manage noise, MCMC parameters for simulation steps, and search parameters for algorithmic inference.</p>
<p>Your primary goal is to develop the <code class="docutils literal notranslate"><span class="pre">Renderer</span></code> and <code class="docutils literal notranslate"><span class="pre">Painter</span></code> classes. The <code class="docutils literal notranslate"><span class="pre">BroadenAndBlur</span></code> module applies broadening to simulate ink spread and blurring to simulate its interaction with paper, controlled by specified parameters. The <code class="docutils literal notranslate"><span class="pre">Renderer</span></code> class uses these effects to process the strokes, while the <code class="docutils literal notranslate"><span class="pre">Painter</span></code> class is responsible for converting vector stroke representations into rasterized images, managing ink distribution based on stroke trajectory, and ensuring that strokes adhere to canvas bounds.</p>
<section id="parameters">
<h3>Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Parameters</span>
<span class="c1"># @markdown</span>

<span class="k">class</span> <span class="nc">Parameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Library to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libname</span> <span class="o">=</span> <span class="s1">'library'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_rendering_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_spline_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_image_model_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mcmc_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_search_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_rendering_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">105</span><span class="p">,</span> <span class="mi">105</span><span class="p">])</span> <span class="c1"># image size</span>

        <span class="c1">## ink-add parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span> <span class="o">=</span> <span class="mf">2.</span> <span class="c1"># amount of ink per point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_max_dist</span> <span class="o">=</span> <span class="mf">2.</span> <span class="c1"># distance between points to which you get full ink</span>

        <span class="c1">## broadening parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_ncon</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># number of convolutions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># parameter 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_b</span> <span class="o">=</span> <span class="mf">6.</span> <span class="c1"># parameter 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broaden_mode</span> <span class="o">=</span> <span class="s1">'Lake'</span> <span class="c1"># broadening version (must be either "Lake" or "Hinton")</span>

        <span class="c1">## blurring parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsize</span> <span class="o">=</span> <span class="mi">11</span> <span class="c1"># convolution size for blurring</span>

    <span class="k">def</span> <span class="nf">set_spline_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters for creating a trajectory from a spline</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spline_max_neval</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># maxmium number of evaluations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spline_min_neval</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># minimum number of evaluations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spline_grain</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># 1 trajectory point for every this many units pixel distance</span>

    <span class="k">def</span> <span class="nf">set_image_model_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Max/min noise parameters for image model</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_blur_sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># min/max blur sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_blur_sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># min/max blur sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epsilon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># min/max pixel epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_epsilon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># min/max pixel epsilon</span>

    <span class="k">def</span> <span class="nf">set_mcmc_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        MCMC parameters</span>
<span class="sd">        """</span>
        <span class="c1">## chain parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_nsamp_type_chain</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># number of samples to take in the MCMC chain (for classif.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_nsamp_type_store</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># number of samples to store from this chain (for classif.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_nsamp_token_chain</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># for completion (we take last sample in this chain)</span>

        <span class="c1">## mcmc proposal parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_prop_gpos_sd</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># global position move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_prop_shape_sd</span> <span class="o">=</span> <span class="mi">3</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># shape move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_prop_scale_sd</span> <span class="o">=</span> <span class="mf">0.0235</span> <span class="c1"># scale move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_prop_relmid_sd</span> <span class="o">=</span> <span class="mf">0.2168</span> <span class="c1"># attach relation move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_prop_relpos_mlty</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># multiply the sd of the standard position noise by this to propose new positions from prior</span>

    <span class="k">def</span> <span class="nf">set_search_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters of search algorithm (part of inference)</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># number of particles to use in search algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_affine_scale_change</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># scale changes must be less than a factor of 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_affine_shift_change</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># shift changes must less than this</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="broaden-and-blur">
<h3>Broaden and Blur<a class="headerlink" href="#broaden-and-blur" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Broaden and Blur</span>
<span class="c1"># @markdown</span>

<span class="k">class</span> <span class="nc">BroadenAndBlur</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">blur_fsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PM</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">PM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">PM</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">blur_fsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blur_fsize</span> <span class="o">=</span> <span class="n">PM</span><span class="o">.</span><span class="n">fsize</span>
        <span class="k">assert</span> <span class="n">blur_fsize</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'blur conv filter size must be odd'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'H_broaden'</span><span class="p">,</span> <span class="n">broaden_filter</span><span class="p">(</span><span class="n">PM</span><span class="o">.</span><span class="n">ink_a</span><span class="p">,</span> <span class="n">PM</span><span class="o">.</span><span class="n">ink_b</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'H_blur'</span><span class="p">,</span> <span class="n">blur_filter</span><span class="p">(</span><span class="n">blur_fsize</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbroad</span> <span class="o">=</span> <span class="n">PM</span><span class="o">.</span><span class="n">ink_ncon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blur_pad</span> <span class="o">=</span> <span class="n">blur_fsize</span><span class="o">//</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blur_sigma</span> <span class="o">=</span> <span class="n">blur_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blur_fsize</span> <span class="o">=</span> <span class="n">blur_fsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_broaden</span><span class="o">.</span><span class="n">device</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_broaden</span><span class="o">.</span><span class="n">is_cuda</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : torch.Tensor</span>
<span class="sd">            [n,H,W] pre-conv image probabilities</span>
<span class="sd">        blur_sigma : float | None</span>
<span class="sd">            amount of blur. 'None' means use value from __init__ call</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x : torch.Tensor</span>
<span class="sd">            [n,H,W] post-conv image probabilities</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">blur_sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">H_blur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_blur</span>
            <span class="n">blur_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur_sigma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blur_sigma</span> <span class="o">=</span> <span class="n">check_float_tesnor</span><span class="p">(</span><span class="n">blur_sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">H_blur</span> <span class="o">=</span> <span class="n">blur_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blur_fsize</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">epsilon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">check_float_tesnor</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># unsqueeze</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># apply broaden</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbroad</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_broaden</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">hardtanh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># return if no blur</span>
        <span class="k">if</span> <span class="n">blur_sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="c1"># apply blur</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">H_blur</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blur_pad</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">hardtanh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># apply pixel noise</span>
        <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">epsilon</span><span class="p">)</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">epsilon</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># squeeze</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="hidden-methods-for-renderer-and-painter">
<h3>Hidden methods for Renderer and Painter<a class="headerlink" href="#hidden-methods-for-renderer-and-painter" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Hidden methods for Renderer and Painter</span>
<span class="c1"># @markdown</span>

<span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">painter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">painter</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">broaden_and_blur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broaden_and_blur</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

<span class="k">def</span> <span class="nf">forward_partial_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drawing</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    In this version, we include all partial canvas renders in addition</span>
<span class="sd">    to the final renders</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drawing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">painter</span><span class="o">.</span><span class="n">forward_partial</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drawing</span><span class="p">]</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pimgs</span><span class="p">]</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pimgs</span><span class="p">)</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broaden_and_blur</span><span class="p">(</span><span class="n">pimgs</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">concat</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pimgs</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pimgs</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">pimgs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">painter</span><span class="o">.</span><span class="n">forward_partial</span><span class="p">(</span><span class="n">drawing</span><span class="p">)</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broaden_and_blur</span><span class="p">(</span><span class="n">pimgs</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pimgs</span>

<span class="k">def</span> <span class="nf">forward_partial_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drawing</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    In this version, we include all partial canvas renders in addition</span>
<span class="sd">    to the final renders</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cuda</span>
    <span class="n">drawing</span> <span class="o">=</span> <span class="n">drawings_to_cpu</span><span class="p">(</span><span class="n">drawing</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawing</span><span class="p">)</span>
    <span class="n">pimgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">)</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drawing</span><span class="p">):</span>
        <span class="n">canvas</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_stroke</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">stk</span><span class="p">)</span>
        <span class="n">pimgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span>
    <span class="k">return</span> <span class="n">pimgs</span>

<span class="k">def</span> <span class="nf">check_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">myt</span><span class="p">):</span>
    <span class="n">xt</span> <span class="o">=</span> <span class="n">myt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yt</span> <span class="o">=</span> <span class="n">myt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">x_out</span> <span class="o">|</span> <span class="n">y_out</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">seqadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">lind_x</span><span class="p">,</span> <span class="n">lind_y</span><span class="p">,</span> <span class="n">inkval</span><span class="p">):</span>
    <span class="n">lind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_mat</span><span class="p">[</span><span class="n">lind_x</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="n">lind_y</span><span class="o">.</span><span class="n">long</span><span class="p">()]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">scatter_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lind</span><span class="p">,</span> <span class="n">inkval</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">D</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Renderer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">blur_fsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PM</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">PM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">PM</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">painter</span> <span class="o">=</span> <span class="n">Painter</span><span class="p">(</span><span class="n">PM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broaden_and_blur</span> <span class="o">=</span> <span class="n">BroadenAndBlur</span><span class="p">(</span><span class="n">blur_sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">blur_fsize</span><span class="p">,</span> <span class="n">PM</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drawings</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Render each drawing by converting the drawing to image ink</span>
<span class="sd">        and then applying broaden &amp; blur filters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        drawings : list[list[torch.Tensor]] | list[torch.Tensor]</span>
<span class="sd">            Input drawings. Each drawing is a list of tensors</span>
<span class="sd">        blur_sigma : float | None</span>
<span class="sd">            Sigma parameter for blurring. Only used for adaptive blurring.</span>
<span class="sd">            Default 'None' means use the blur_sigma from __init__() call</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pimgs : torch.Tensor</span>
<span class="sd">            [n,H,W] Pre-conv image probabilities</span>
<span class="sd">        """</span>

        <span class="c1">#################################################</span>
        <span class="c1">## TODO for students: fill in the missing variables ##</span>
        <span class="c1"># Fill out function and remove</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Student exercise: fill in the missing variables"</span><span class="p">)</span>
        <span class="c1">#################################################</span>

        <span class="c1"># draw the strokes (this part on cpu)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drawings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">drawings</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawings</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">pimgs</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broaden_and_blur</span><span class="p">(</span><span class="n">pimgs</span><span class="p">,</span> <span class="n">blur_sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span> <span class="c1"># (n,H,W)</span>

        <span class="k">if</span> <span class="n">single</span><span class="p">:</span>
            <span class="n">pimgs</span> <span class="o">=</span> <span class="n">pimgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pimgs</span>

<span class="k">class</span> <span class="nc">Painter</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PM</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">PM</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">PM</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span> <span class="o">=</span> <span class="n">PM</span><span class="o">.</span><span class="n">ink_pp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ink_max_dist</span> <span class="o">=</span> <span class="n">PM</span><span class="o">.</span><span class="n">ink_max_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'index_mat'</span><span class="p">,</span>
                             <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">PM</span><span class="o">.</span><span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">PM</span><span class="o">.</span><span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">PM</span><span class="o">.</span><span class="n">imsize</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'space_flip'</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span> <span class="o">=</span> <span class="n">PM</span><span class="o">.</span><span class="n">imsize</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_mat</span><span class="o">.</span><span class="n">device</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_mat</span><span class="o">.</span><span class="n">is_cuda</span>

    <span class="k">def</span> <span class="nf">space_motor_to_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stk</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">stk</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">space_flip</span>

    <span class="k">def</span> <span class="nf">add_stroke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pimg</span><span class="p">,</span> <span class="n">stk</span><span class="p">):</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_motor_to_img</span><span class="p">(</span><span class="n">stk</span><span class="p">)</span>
        <span class="c1"># reduce trajectory to only those points that are in bounds</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_bounds</span><span class="p">(</span><span class="n">stk</span><span class="p">)</span> <span class="c1"># boolean; shape (neval,)</span>
        <span class="n">ink_off_page</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">pimg</span><span class="p">,</span> <span class="n">ink_off_page</span>
        <span class="n">stk</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[</span><span class="o">~</span><span class="n">out</span><span class="p">]</span>

        <span class="c1"># compute distance between each trajectory point and the next one</span>
        <span class="k">if</span> <span class="n">stk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">myink</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">stk</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">stk</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># shape (k,)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ink_max_dist</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">dist</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">dist</span><span class="p">])</span>
            <span class="n">myink</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ink_max_dist</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span> <span class="c1"># shape (k,)</span>

        <span class="c1"># make sure we have the minimum amount of ink, if a particular</span>
        <span class="c1"># trajectory is very small</span>
        <span class="n">sumink</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">myink</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sumink</span> <span class="o">&lt;</span> <span class="mf">2.22e-6</span><span class="p">:</span>
            <span class="n">nink</span> <span class="o">=</span> <span class="n">myink</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">myink</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span><span class="o">/</span><span class="n">nink</span><span class="p">)</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">myink</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sumink</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span><span class="p">:</span>
            <span class="n">myink</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span><span class="o">/</span><span class="n">sumink</span><span class="p">)</span><span class="o">*</span><span class="n">myink</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">myink</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ink_pp</span> <span class="o">-</span> <span class="mf">1e-4</span><span class="p">)</span>

        <span class="c1"># share ink with the neighboring 4 pixels</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xfloor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">yfloor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">xceil</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">yceil</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">x_c_ratio</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xfloor</span>
        <span class="n">y_c_ratio</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">yfloor</span>
        <span class="n">x_f_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x_c_ratio</span>
        <span class="n">y_f_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">y_c_ratio</span>
        <span class="n">lind_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">xfloor</span><span class="p">,</span> <span class="n">xceil</span><span class="p">,</span> <span class="n">xfloor</span><span class="p">,</span> <span class="n">xceil</span><span class="p">])</span>
        <span class="n">lind_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">yfloor</span><span class="p">,</span> <span class="n">yfloor</span><span class="p">,</span> <span class="n">yceil</span><span class="p">,</span> <span class="n">yceil</span><span class="p">])</span>
        <span class="n">inkval</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
            <span class="n">myink</span><span class="o">*</span><span class="n">x_f_ratio</span><span class="o">*</span><span class="n">y_f_ratio</span><span class="p">,</span>
            <span class="n">myink</span><span class="o">*</span><span class="n">x_c_ratio</span><span class="o">*</span><span class="n">y_f_ratio</span><span class="p">,</span>
            <span class="n">myink</span><span class="o">*</span><span class="n">x_f_ratio</span><span class="o">*</span><span class="n">y_c_ratio</span><span class="p">,</span>
            <span class="n">myink</span><span class="o">*</span><span class="n">x_c_ratio</span><span class="o">*</span><span class="n">y_c_ratio</span>
        <span class="p">])</span>
        <span class="c1"># paint the image</span>
        <span class="n">pimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seqadd</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">lind_x</span><span class="p">,</span> <span class="n">lind_y</span><span class="p">,</span> <span class="n">inkval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pimg</span><span class="p">,</span> <span class="n">ink_off_page</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pimg</span><span class="p">,</span> <span class="n">strokes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">stk</span> <span class="ow">in</span> <span class="n">strokes</span><span class="p">:</span>
            <span class="n">pimg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="o">...</span>
        <span class="k">return</span> <span class="n">pimg</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drawings</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cuda</span>
        <span class="n">drawings</span> <span class="o">=</span> <span class="n">drawings_to_cpu</span><span class="p">(</span><span class="n">drawings</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawings</span><span class="p">)</span>
        <span class="n">pimgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">pimgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
        <span class="k">return</span> <span class="n">pimgs</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/neuromatch/NeuroAI_Course/tree/main/tutorials/W1D1_Generalization/solutions/W1D1_Tutorial3_Solution_687263d1.py"><em>Click for solution</em></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example of visualizing parses for a specific item and run</span>

<span class="c1"># Add hidden methods (otherwise code would have been too long)</span>
<span class="n">Renderer</span><span class="o">.</span><span class="n">cuda</span> <span class="o">=</span> <span class="n">cuda</span>
<span class="n">Renderer</span><span class="o">.</span><span class="n">forward_partial_r</span> <span class="o">=</span> <span class="n">forward_partial_r</span>
<span class="n">Painter</span><span class="o">.</span><span class="n">forward_partial_p</span> <span class="o">=</span> <span class="n">forward_partial_p</span>
<span class="n">Painter</span><span class="o">.</span><span class="n">check_bounds</span> <span class="o">=</span> <span class="n">check_bounds</span>
<span class="n">Painter</span><span class="o">.</span><span class="n">seqadd</span> <span class="o">=</span> <span class="n">seqadd</span>

<span class="c1"># Now create instances of Renderer and Painter</span>
<span class="n">renderer_instance</span> <span class="o">=</span> <span class="n">Renderer</span><span class="p">()</span>
<span class="n">painter_instance</span> <span class="o">=</span> <span class="n">Painter</span><span class="p">()</span>

<span class="n">visualize_parses</span><span class="p">(</span><span class="n">Renderer</span><span class="p">,</span> <span class="n">collected_data</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>Submit your feedback<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Submit your feedback</span>
<span class="c1"># content_review(f"{feedback_prefix}_Building_Stroke_Exercise")</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
</section>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tutorials/W1D1_Generalization/student"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</article>
<footer class="bd-footer-article">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="W1D1_Tutorial2.html" id="prev-link" title="previous page">
<i class="fa-solid fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Tutorial 2: Generalization in Neuroscience</p>
</div>
</a>
<a class="right-next" href="W1D1_Outro.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Outro</p>
</div>
<i class="fa-solid fa-angle-right"></i>
</a>
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc">
<div class="toc-item">
<div class="tocsection onthispage">
<i class="fa-solid fa-list"></i> On this page
</div>
<nav class="page-toc" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 3: Generalization in Cognitive Science
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#tutorial-objectives">
   Tutorial Objectives
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
   Setup
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#install-dependencies">
     Install dependencies
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#import-dependencies">
     Import dependencies
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions">
     Plotting functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-retrieval-for-zip-files">
     Data retrieval for zip files
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-retrieval-for-torch-models">
     Data retrieval for torch models
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#activity-1-exploring-the-omniglot-dataset">
     Activity 1: Exploring the Omniglot dataset
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-generalization-in-cognitive-science">
       Video 1: Generalization in Cognitive Science
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#reflection-activity">
     Reflection activity
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#submit-your-feedback">
       Submit your feedback
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#activity-2-building-alternative-bottom-up-parses">
     Activity 2: Building alternative bottom-up parses
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Submit your feedback
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#activity-3-building-a-single-stroke-model">
     Activity 3: Building a single stroke model
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#parameters">
       Parameters
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#broaden-and-blur">
       Broaden and Blur
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#hidden-methods-for-renderer-and-painter">
       Hidden methods for Renderer and Painter
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
       Submit your feedback
      </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By Neuromatch
</p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
<p class="last-updated">
Last updated on None.<br/>
</p>
</div>
<div class="footer-item">
<div class="extra_footer">
<div>
<a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png"/></a>
<a href="https://opensource.org/licenses/BSD-3-Clause"><img src="https://camo.githubusercontent.com/9b9ea65d95c9ef878afa1987df65731d47681336/68747470733a2f2f696d672e736869656c64732e696f2f707970692f6c2f736561626f726e2e737667"/></a>
The contents of this repository are shared under the <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
Software elements are additionally licensed under the <a href="https://opensource.org/licenses/BSD-3-Clause">BSD (3-Clause) License</a>.
</div>
</div>
</div>
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>
</body>
</html>